<!DOCTYPE html>
<html>
<head>
    <title>Spam Detection System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .spam-result { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .ham-result { background-color: #d1edff; border-left: 4px solid #0d6efd; }
        .service-status { 
            padding: 5px 10px; 
            border-radius: 20px; 
            font-size: 0.8em;
        }
        .service-up { background: #d4edda; color: #155724; }
        .service-down { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <h1 class="text-center mb-4">Spam Detection System</h1>
                
                <div class="text-center mb-4">
                    <span class="service-status {% if service_status %}service-up{% else %}service-down{% endif %}">
                        ML Service: {% if service_status %}‚úÖ Online{% else %}‚ùå Offline{% endif %}
                    </span>
                </div>

                <div class="card">
                    <div class="card-body">
                        <form id="spamForm">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="textInput" class="form-label">Enter text to check for spam:</label>
                                <textarea class="form-control" id="textInput" rows="4" 
                                          placeholder="Type your message here..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Check for Spam</button>
                        </form>
                    </div>
                </div>

                <div id="result" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Prediction Result</h5>
                            <div id="resultContent"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <button class="btn btn-outline-secondary" onclick="loadHistory()">Show Recent Checks</button>
                    <div id="history" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('spamForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const text = document.getElementById('textInput').value.trim();
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            if (!text) {
                alert('Please enter some text');
                return;
            }

            try {
                const response = await fetch('/api/check-spam/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({text: text})
                });

                const result = await response.json();
                
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    displayResult(result, text);
                }
            } catch (error) {
                alert('Request failed: ' + error);
            }
        });

        function displayResult(result, originalText) {
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            const isSpam = result.is_spam;
            const confidence = (result.confidence * 100).toFixed(2);
            
            resultContent.innerHTML = `
                <div class="p-3 rounded ${isSpam ? 'spam-result' : 'ham-result'}">
                    <h6 class="${isSpam ? 'text-danger' : 'text-success'}">
                        ${isSpam ? 'üö´ SPAM' : '‚úÖ HAM'}
                    </h6>
                    <p><strong>Text:</strong> "${originalText}"</p>
                    <p><strong>Confidence:</strong> ${confidence}%</p>
                    <p><strong>Prediction:</strong> ${result.prediction.toUpperCase()}</p>
                </div>
            `;
            
            resultDiv.style.display = 'block';
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/history/');
                const data = await response.json();
                
                const historyDiv = document.getElementById('history');
                
                if (data.predictions.length === 0) {
                    historyDiv.innerHTML = '<p>No prediction history yet.</p>';
                    return;
                }
                
                let html = '<h6>Recent Predictions:</h6>';
                data.predictions.forEach(pred => {
                    html += `
                        <div class="card mb-2 ${pred.is_spam ? 'border-danger' : 'border-success'}">
                            <div class="card-body py-2">
                                <small>
                                    <strong>${pred.is_spam ? 'üö´ SPAM' : '‚úÖ HAM'}</strong> 
                                    (${(pred.confidence * 100).toFixed(1)}%)<br>
                                    "${pred.text}"<br>
                                    <em class="text-muted">${new Date(pred.created_at).toLocaleString()}</em>
                                </small>
                            </div>
                        </div>
                    `;
                });
                
                historyDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }
    </script>
</body>
</html>
